<?xml version="1.0" ?>
<!DOCTYPE modification [
<!ENTITY adminFolder "admin">
<!ENTITY themeFolder "default">
]>
<modification>
	<id>Digital Multiseller Marketplace</id>
	<version>1.3.1</version>
	<vqmver>1.0.8</vqmver>
	<author>http://ffct.cc</author>
	
	<!-- ************************ -->
	<!-- ************************ -->
	<!--         SYSTEM           -->
	<!-- ************************ -->	
	<!-- ************************ -->
		
	<file name="system/library/customer.php">
		<operation>
			<search position="after"><![CDATA[
				public function logout() {
			]]></search>
			<add><![CDATA[
				unset($this->session->data['multiseller']);
			]]></add>
		</operation>
	</file>

	<file name="&adminFolder;/controller/extension/module.php">
		<operation>
			<search position="replace"><![CDATA[
				$this->model_setting_extension->uninstall('module', $value);
			]]></search>
			<add><![CDATA[
				if (!in_array($value,array('ms_carousel'))) {
					$this->model_setting_extension->uninstall('module', $value);
				}
			]]></add>
		</operation>
	</file>

	
	<!-- ************************ -->
	<!-- ************************ -->
	<!--       FRONT OFFICE       -->
	<!-- ************************ -->	
	<!-- ************************ -->	
	
	<!-- number of sellers/products line -->
	<file name="catalog/view/theme/&themeFolder;/template/common/header.tpl">
		<operation error="log">
			<search position="after"><![CDATA[
				<div class="links"><a href="<?php echo $home; ?>"><?php echo $text_home; ?></a><a href="<?php echo $wishlist; ?>" id="wishlist-total"><?php echo $text_wishlist; ?></a><a href="<?php echo $account; ?>"><?php echo $text_account; ?></a><a href="<?php echo $shopping_cart; ?>"><?php echo $text_shopping_cart; ?></a><a href="<?php echo $checkout; ?>"><?php echo $text_checkout; ?></a></div>
			]]></search>
			<add><![CDATA[
				<div style="position: absolute; bottom: 3px; left: 0; font-weight: bold; color: #38B0E3"><?php echo sprintf($ms_totals_line, $ms_total_sellers, $ms_total_products); ?></div>
			]]></add>
		</operation>	
	</file>

	<file name="catalog/controller/common/header.php">
		<operation error="log">
			<search position="after"><![CDATA[
				protected function index() {
			]]></search>
			<add><![CDATA[
				$this->data = array_merge($this->data, $this->load->language('module/multiseller'));
				require_once(DIR_SYSTEM . 'library/ms-seller.php');
				$msSeller = new MsSeller($this->registry);
				require_once(DIR_SYSTEM . 'library/ms-product.php');
				$msProduct = new MsProduct($this->registry);				

				$this->data['ms_total_products'] = $msProduct->getTotalProducts(TRUE, FALSE);
				$this->data['ms_total_sellers'] = $msSeller->getTotalSellers(TRUE);
			]]></add>
		</operation>	
	</file>
	<!-- seller account area links -->
	<file name="catalog/view/theme/&themeFolder;/template/account/account.tpl">
		<operation>
			<search position="before"><![CDATA[
				<h2><?php echo $text_my_newsletter; ?></h2>
			]]></search>
			<add><![CDATA[
			  <h2><?php echo $ms_account_seller_account; ?></h2>
			  <div class="content">
			    <ul>
				  <?php if ($ms_seller_created) { ?>
				      <li><a href="<?php echo $ms_link_sellerinfo; ?>"><?php echo $ms_account_sellerinfo; ?></a></li>
				      <li><a href="<?php echo $ms_link_newproduct; ?>"><?php echo $ms_account_newproduct; ?></a></li>
				      <li><a href="<?php echo $ms_link_products; ?>"><?php echo $ms_account_products; ?></a></li>
				      <li><a href="<?php echo $ms_link_transactions; ?>"><?php echo $ms_account_transactions; ?></a></li>
				      <li><a href="<?php echo $ms_link_withdraw; ?>"><?php echo $ms_account_withdraw; ?></a></li>
				  <?php } else { ?>
				  	  <li><a href="<?php echo $ms_link_sellerinfo; ?>"><?php echo $ms_account_create; ?></a></li>
				  <?php } ?>
			    </ul>
			  </div>
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/account/account.php">
		<operation>
			<search position="before"><![CDATA[
				$this->response->setOutput($this->render());
			]]></search>
			<add><![CDATA[
				require_once(DIR_SYSTEM . 'library/ms-seller.php');
				$msSeller = new MsSeller($this->registry);
				$this->data['ms_seller_created'] = $msSeller->isCustomerSeller($this->customer->getId());
				$this->data = array_merge($this->data, $this->load->language('module/multiseller'));			
				$this->data['ms_link_sellerinfo'] = $this->url->link('account/ms-seller/sellerinfo', '', 'SSL');
				$this->data['ms_link_newproduct'] = $this->url->link('account/ms-seller/newproduct', '', 'SSL');
				$this->data['ms_link_products'] = $this->url->link('account/ms-seller/products', '', 'SSL');
				$this->data['ms_link_transactions'] = $this->url->link('account/ms-seller/transactions', '', 'SSL');
				$this->data['ms_link_withdraw'] = $this->url->link('account/ms-seller/withdraw', '', 'SSL');
			]]></add>
		</operation>
	</file>

	<!-- seller account SIDEBAR area links -->
	<file name="catalog/view/theme/&themeFolder;/template/module/account.tpl">
		<operation>
			<search position="before"><![CDATA[
			</ul>
			]]></search>
			<add><![CDATA[
				<br />
			  <li style="list-style-type: none"><b><?php echo $ms_account_seller_account; ?></b></li>
			  <?php if ($ms_seller_created) { ?>
			      <li><a href="<?php echo $ms_link_sellerinfo; ?>"><?php echo $ms_account_sellerinfo; ?></a></li>
			      <li><a href="<?php echo $ms_link_newproduct; ?>"><?php echo $ms_account_newproduct; ?></a></li>
			      <li><a href="<?php echo $ms_link_products; ?>"><?php echo $ms_account_products; ?></a></li>
			      <li><a href="<?php echo $ms_link_transactions; ?>"><?php echo $ms_account_transactions; ?></a></li>
			      <li><a href="<?php echo $ms_link_withdraw; ?>"><?php echo $ms_account_withdraw; ?></a></li>
			  <?php } else { ?>
			  	  <li><a href="<?php echo $ms_link_sellerinfo; ?>"><?php echo $ms_account_create; ?></a></li>
			  <?php } ?>
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/common/footer.php">
		<operation>
			<search position="after"><![CDATA[
				protected function index() {
			]]></search>
			<add><![CDATA[
				$this->data = array_merge($this->data, $this->load->language('module/multiseller'));
			]]></add>
		</operation>
	</file>

	<file name="catalog/view/theme/&themeFolder;/template/common/footer.tpl">
		<operation error="skip">
			<search position="replace"><![CDATA[
			<div id="powered"><?php echo $powered; ?></div>
			]]></search>
			<add><![CDATA[
			<div id="powered"><?php echo $powered; ?><?php echo $ms_footer; ?></div>
			]]></add>
		</operation>
	</file>

	<file name="catalog/controller/module/account.php">
		<operation>
			<search position="before"><![CDATA[
				$this->render();
			]]></search>
			<add><![CDATA[
				require_once(DIR_SYSTEM . 'library/ms-seller.php');
				$msSeller = new MsSeller($this->registry);
				$this->data['ms_seller_created'] = $msSeller->isCustomerSeller($this->customer->getId());			
				$this->data = array_merge($this->data, $this->load->language('module/multiseller'));			
				$this->data['ms_link_sellerinfo'] = $this->url->link('account/ms-seller/sellerinfo', '', 'SSL');
				$this->data['ms_link_newproduct'] = $this->url->link('account/ms-seller/newproduct', '', 'SSL');
				$this->data['ms_link_products'] = $this->url->link('account/ms-seller/products', '', 'SSL');
				$this->data['ms_link_transactions'] = $this->url->link('account/ms-seller/transactions', '', 'SSL');
				$this->data['ms_link_withdraw'] = $this->url->link('account/ms-seller/withdraw', '', 'SSL');
			]]></add>
		</operation>
	</file>


	<!-- transactions for order -->
	<file name="catalog/model/checkout/order.php">
		<operation>
			<search position="after"><![CDATA[
				$this->db->query("UPDATE `" . DB_PREFIX . "order` SET order_status_id = '" . (int)$order_status_id . "', date_modified = NOW() WHERE order_id = '" . (int)$order_id . "'");
			]]></search>
			<add><![CDATA[
				require_once(DIR_SYSTEM . 'library/ms-transaction.php');
				require_once(DIR_SYSTEM . 'library/ms-mail.php');
				$msTransaction = new MsTransaction($this->registry);
				$msMail = new MsMail($this->registry);

				if (in_array($order_status_id, explode(',',$this->config->get('msconf_credit_order_statuses')))) {
					$msTransaction->addTransactionsForOrder($order_id);
					$msMail->sendOrderMails($order_id);
				} else if (in_array($order_status_id, explode(',',$this->config->get('msconf_debit_order_statuses')))) {
					$msTransaction->addTransactionsForOrder($order_id, TRUE);
				}
			]]></add>
		</operation>
		
		<!-- increment sold counter -->		
		<operation>
			<search position="after"><![CDATA[
				$this->db->query("UPDATE " . DB_PREFIX . "product SET quantity = (quantity - " . (int)$order_product['quantity'] . ") WHERE product_id = '" . (int)$order_product['product_id'] . "' AND subtract = '1'");
			]]></search>
			<add><![CDATA[
				
				$this->db->query("UPDATE " . DB_PREFIX . "ms_product SET number_sold  = (number_sold + " . (int)$order_product['quantity'] . ") WHERE product_id = '" . (int)$order_product['product_id'] . "'");
			]]></add>
		</operation>		
	</file>
	
	<file name="catalog/view/theme/&themeFolder;/template/product/product.tpl">
		<!-- seller information on product page -->
		<operation>
			<search position="before"><![CDATA[
			<div class="description">
			]]></search>
			<add><![CDATA[
			<?php if (isset($seller) && !empty($seller)) { ?>
		    <div class="ms-sellerprofile description">
				<span><?php echo $ms_catalog_product_sellerinfo; ?></span>		    
		    	<div class="seller-data">
		    		<div class="avatar-box">
		    			<a style="text-decoration: none" href="<?php echo $seller['href']; ?>"><h2><?php echo $seller['nickname']; ?></h2></a>
		    			<a href="<?php echo $seller['href']; ?>"><img src="<?php echo $seller['thumb']; ?>" /></a>
		    		</div>
		    		<div class="info-box">
		    			<?php if ($seller['country']) { ?>
			    			<p><b><?php echo $ms_catalog_seller_profile_country; ?></b> <?php echo $seller['country']; ?></p>
			    		<?php } ?>
		
			    		<?php if ($seller['company']) { ?>
			    			<p><b><?php echo $ms_catalog_seller_profile_company; ?></b> <?php echo $seller['company']; ?></p>
			    		<?php } ?>
			    		
			    		<?php if ($seller['website']) { ?>
			    			<p><b><?php echo $ms_catalog_seller_profile_website; ?></b> <?php echo $seller['website']; ?></p>
			    		<?php } ?>
			    		
			    		<p><b><?php echo $ms_catalog_seller_profile_totalsales; ?></b> <?php echo $seller['total_sales']; ?></p>
			    		<p><b><?php echo $ms_catalog_seller_profile_totalproducts; ?></b> <?php echo $seller['total_products']; ?></p>
			    		sssss
			    		<p><a class="ms-sellercontact"><?php echo $ms_catalog_product_contact; ?></a></p>
		    		</div>
		    	</div>
		    </div>
			<?php } ?>
		</div>			
			]]></add>
		</operation>
		
		<!-- product comments -->
		<operation>
			<search position="before" offset="1"><![CDATA[
				<div id="tab-description" class="tab-content"><?php echo $description; ?></div>
			]]></search>
			<add><![CDATA[
  				<a href="#tab-comments"><?php echo $tab_comments ?></a>
			]]></add>
		</operation>
		
		<operation>
			<search position="before"><![CDATA[
				<?php if ($tags) { ?>
			]]></search>
			<add><![CDATA[
  				<div id="tab-comments" class="tab-content"></div>
			]]></add>
		</operation>
	
		<operation>
			<search position="replace"><![CDATA[
				<span><?php echo $text_stock; ?></span> <?php echo $stock; ?></div>
			]]></search>
			<add><![CDATA[
  				<span><?php echo $text_stock; ?></span> <?php echo $stock; ?><br />
  				<?php foreach ($ms_product_attributes as $attribute) { ?>
	  				<span><?php echo $attribute['name']; ?></span> <?php echo implode(',',$attribute['values']); ?> <br />
  				<?php } ?>
  				</div>
			]]></add>
		</operation>
		
		<operation>
			<search position="before"><![CDATA[
				$('#button-review').bind('click', function() {
			]]></search>
			<add><![CDATA[
  				$('#tab-comments').load('index.php?route=module/ms-comments/getComments&product_id=<?php echo $product_id; ?>');
			]]></add>
		</operation>		
	</file>

	<file name="catalog/controller/product/product.php">
		<!-- seller information on product page -->	
		<operation>
			<search position="after"><![CDATA[
			if ($product_info) {
			]]></search>
			<add><![CDATA[
			$this->document->addScript('catalog/view/javascript/ms-contactseller.js');
			$this->document->addStyle('catalog/view/theme/' . $this->config->get('config_template') . '/stylesheet/multiseller.css');
			$this->data = array_merge($this->data, $this->load->language('module/multiseller'));
			require_once(DIR_SYSTEM . 'library/ms-image.php');
			require_once(DIR_SYSTEM . 'library/ms-product.php');
			require_once(DIR_SYSTEM . 'library/ms-seller.php');
			$this->load->model('localisation/country');
			$image = new MsImage($this->registry);
			$msProduct = new MsProduct($this->registry);
			$msSeller = new MsSeller($this->registry);
			
			$seller_id = $msProduct->getSellerId($this->request->get['product_id']);
			$seller = $msSeller->getSellerData($seller_id);
			
			if (empty($seller)) {
				$this->data['seller'] = NULL;
			} else {
				if (!empty($seller['avatar_path']))
					$this->data['seller']['thumb'] = $image->resize($seller['avatar_path'], $this->config->get('config_image_category_width'), $this->config->get('config_image_category_height'));
					
				$country = $this->model_localisation_country->getCountry($seller['country_id']);
				
				if (!empty($country)) {			
					$this->data['seller']['country'] = $country['name'];
				} else {
					$this->data['seller']['country'] = NULL;
				}
				
				if (!empty($seller['company'])) {
					$this->data['seller']['company'] = $seller['company'];
				} else {
					$this->data['seller']['company'] = NULL;
				}
				
				if (!empty($seller['website'])) {
					$this->data['seller']['website'] = $seller['website'];
				} else {
					$this->data['seller']['website'] = NULL;
				}
				
				$this->data['seller']['nickname'] = $seller['nickname'];
				
				$this->data['seller']['href'] = $this->url->link('product/seller/profile', 'seller_id=' . $seller['seller_id']);
				
				$this->data['seller']['total_sales'] = $msSeller->getSalesForSeller($seller['seller_id']);
				$this->data['seller']['total_products'] = $msSeller->getTotalSellerProducts($seller['seller_id'], TRUE);
			}

			$this->data['ms_product_attributes'] = $msProduct->getProductAttributes($this->request->get['product_id']);

			]]></add>
		</operation>
		
		<!--  product comments  -->
		<operation>
			<search position="before"><![CDATA[
			    $this->data['tab_related'] = $this->language->get('tab_related');
			]]></search>
			<add><![CDATA[
				$this->load->model('module/multiseller/comments');
				$this->language->load('module/multiseller');
				$this->data['tab_comments'] = sprintf($this->language->get('ms_comments_tab_comments'), $this->model_module_multiseller_comments->getCommentsCount($this->request->get['product_id']));
			]]></add>
		</operation>
	</file>

	<!-- ************************ -->
	<!-- ************************ -->
	<!--       BACK OFFICE        -->
	<!-- ************************ -->	
	<!-- ************************ -->

	<file name="&adminFolder;/model/sale/order.php">
		<!-- 1.5.2 -->
		<operation error="log">
			<search position="after"><![CDATA[
				$this->db->query("UPDATE `" . DB_PREFIX . "order` SET total = '" . (float)$total . "' WHERE order_id = '" . (int)$order_id . "'");
			]]></search>
			<add><![CDATA[
				require_once(DIR_SYSTEM . 'library/ms-transaction.php');
				$msTransaction = new MsTransaction($this->registry);
				if (in_array($data['order_status_id'], explode(',',$this->config->get('msconf_credit_order_statuses')))) {
					$msTransaction->addTransactionsForOrder($order_id);
				} else if (in_array($data['order_status_id'], explode(',',$this->config->get('msconf_debit_order_statuses')))) {
					$msTransaction->addTransactionsForOrder($order_id, TRUE);
				}
			]]></add>
		</operation>

		<!-- 1.5.3 -->
		<operation error="log">
			<search position="after"><![CDATA[
				$this->db->query("UPDATE `" . DB_PREFIX . "order` SET total = '" . (float)$total . "', affiliate_id = '" . (int)$affiliate_id . "', commission = '" . (float)$commission . "' WHERE order_id = '" . (int)$order_id . "'");
			]]></search>
			<add><![CDATA[
				require_once(DIR_SYSTEM . 'library/ms-transaction.php');
				$msTransaction = new MsTransaction($this->registry);
				if (in_array($data['order_status_id'], explode(',',$this->config->get('msconf_credit_order_statuses')))) {
					$msTransaction->addTransactionsForOrder($order_id);
				} else if (in_array($data['order_status_id'], explode(',',$this->config->get('msconf_debit_order_statuses')))) {
					$msTransaction->addTransactionsForOrder($order_id, TRUE);
				}
			]]></add>
		</operation>
		
		<operation>
			<search position="after"><![CDATA[
				$this->db->query("UPDATE `" . DB_PREFIX . "order` SET order_status_id = '" . (int)$data['order_status_id'] . "', date_modified = NOW() WHERE order_id = '" . (int)$order_id . "'");
			]]></search>
			<add><![CDATA[
				require_once(DIR_SYSTEM . 'library/ms-transaction.php');
				$msTransaction = new MsTransaction($this->registry);
				if (in_array($data['order_status_id'], explode(',',$this->config->get('msconf_credit_order_statuses')))) {
					$msTransaction->addTransactionsForOrder($order_id);
				} else if (in_array($data['order_status_id'], explode(',',$this->config->get('msconf_debit_order_statuses')))) {
					$msTransaction->addTransactionsForOrder($order_id, TRUE);
				}
			]]></add>
		</operation>
	</file>	

	<!-- navigation menu -->
	<file name="&adminFolder;/view/template/common/header.tpl">
		<operation>
			<search position="before" offset="1"><![CDATA[
			<ul class="right">
			]]></search>
			<add><![CDATA[
		      <li id="multiseller"><a class="top"><?php echo $ms_menu_multiseller; ?></a>
		        <ul>
		          <li><a class="parent"><?php echo $ms_menu_catalog; ?></a>
		            <ul>
		           	  <li><a href="<?php echo $ms_link_catalog_sellers; ?>"><?php echo $ms_menu_catalog_sellers; ?></a></li>
		           	  <li><a href="<?php echo $ms_link_catalog_products; ?>"><?php echo $ms_menu_catalog_products; ?></a></li>
		            </ul>
		          </li>		          
		          <li><a class="parent"><?php echo $ms_menu_finances; ?></a>
		            <ul>
		              <li><a href="<?php echo $ms_link_finances_transactions; ?>"><?php echo $ms_menu_finances_transactions; ?></a></li>
		              <li><a href="<?php echo $ms_link_finances_withdrawals; ?>"><?php echo $ms_menu_finances_withdrawals; ?></a></li>
		            </ul>
		          </li>		          
		          <li><a href="<?php echo $ms_link_settings; ?>"><?php echo $ms_menu_settings; ?></a></li>
		        </ul>
		      </li>
			]]></add>
		</operation>
	</file>
	
	<file name="&adminFolder;/controller/common/header.php">
		<operation>
			<search position="after"><![CDATA[
			protected function index() {
			]]></search>
			<add><![CDATA[
			$this->data = array_merge($this->data, $this->load->language('module/multiseller'));
			]]></add>
		</operation>
		
		<operation>
			<search position="before"><![CDATA[
			$this->data['stores'] = array();
			]]></search>
			<add><![CDATA[
			$this->data['ms_link_catalog_sellers'] = $this->url->link('module/multiseller/sellers', 'token=' . $this->session->data['token'], 'SSL');
			$this->data['ms_link_catalog_products'] = $this->url->link('module/multiseller/products', 'token=' . $this->session->data['token'], 'SSL');
			$this->data['ms_link_finances_withdrawals'] = $this->url->link('module/multiseller/withdrawals', 'token=' . $this->session->data['token'], 'SSL');
			$this->data['ms_link_finances_transactions'] = $this->url->link('module/multiseller/transactions', 'token=' . $this->session->data['token'], 'SSL');
			$this->data['ms_link_settings'] = $this->url->link('module/multiseller', 'token=' . $this->session->data['token'], 'SSL'); 
			]]></add>
		</operation>		
	</file>
	
	<file name="&adminFolder;/controller/sale/order.php">
		<operation>
			<search position="before"><![CDATA[
			$this->data['products'][] = array(
			]]></search>
			<add><![CDATA[
			require_once(DIR_SYSTEM . 'library/ms-seller.php');
			$msSeller = new MsSeller($this->registry);
			$this->language->load('module/multiseller');
			$this->data['column_seller'] = $this->language->get('ms_seller');
			$seller = $msSeller->getSellerDataForProduct($product['product_id']);
			]]></add>
		</operation>	
	
		<operation>
			<search position="after"><![CDATA[
			$this->data['products'][] = array(
			]]></search>
			<add><![CDATA[
			'seller' => array(
				'seller_id' => isset($seller['seller_id']) ? $seller['seller_id'] : '',
				'nickname' => isset($seller['nickname']) ? $seller['nickname'] : ''
			),
			]]></add>
		</operation>
	</file>
	
	<file name="&adminFolder;/view/template/sale/order_info.tpl">
		<operation>
			<search position="before"><![CDATA[
			<td class="left"><?php echo $column_product; ?></td>
			]]></search>
			<add><![CDATA[
			<td class="left"><?php echo $column_seller; ?></td>
			]]></add>
		</operation>	
	
		<operation>
			<search position="before"><![CDATA[
			<td class="left"><a href="<?php echo $product['href']; ?>"><?php echo $product['name']; ?></a>
			]]></search>
			<add><![CDATA[
			<td class="left"><?php if (!empty($product['seller']['seller_id'])) { ?><a href="<?php echo $this->url->link('module/multiseller/sellerinfo', 'token=' . $this->session->data['token'] . '&seller_id=' . $product['seller']['seller_id'], 'SSL');?>"><?php echo $product['seller']['nickname']; ?></a> <?php } ?></td>
			]]></add>
		</operation>
		
		<operation>
			<search position="replace"><![CDATA[
			<td colspan="4" class="right"><?php echo $totals['title']; ?>:</td>
			]]></search>
			<add><![CDATA[
			<td colspan="5" class="right"><?php echo $totals['title']; ?>:</td>
			]]></add>
		</operation>		
	</file>
</modification>
